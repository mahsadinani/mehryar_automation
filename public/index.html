<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مهر یار - دستیار هوشمند آموزشگاه مهرابتکار</title>
  <link rel="icon" type="image/png" href="/mehrab-logo.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/mehryar-logo.svg" />
  <style>
    @font-face {
      font-family: 'Yekan';
      font-style: normal;
      font-weight: 400;
      src: url('/fonts/yekan.woff2') format('woff2'),
           url('/fonts/yekan.woff') format('woff');
      font-display: swap;
    }
    @font-face {
      font-family: 'Yekan';
      font-style: normal;
      font-weight: 700;
      src: url('/fonts/yekan-bold.woff2') format('woff2'),
           url('/fonts/yekan-bold.woff') format('woff');
      font-display: swap;
    }
    body { font-family: 'Yekan', Vazirmatn, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b4f84; color: #222; direction: rtl }
    button, input, select, textarea { font-family: inherit }
    header { background: transparent; color: #fff; padding: 20px 0 }
    .brand { display:flex; align-items:center; gap:12px }
    .brand img { width:72px; height:72px; border-radius:50%; background:#fff }
    .brand-title { font-size:22px; font-weight:800 }
    nav { display: flex; gap: 8px; padding: 12px; background: #fff; position: sticky; top: 0; border-bottom: 1px solid #e5e7eb }
    nav button { padding: 8px 12px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; border-radius: 6px }
    nav button.active { background: #2f3e9e; color: #fff; border-color: #2f3e9e }
    main { padding: 16px }
    section { display: none }
    section.active { display: block }
    form { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; background: #fff; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px }
    input, select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px }
    .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px }
    .list { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-top: 12px }
    .list h3 { margin: 0 0 8px }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px }
    .card { border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; background: #fafafa }
    .card .course-banner { width: 100%; max-height: 140px; object-fit: cover; border-radius: 6px; margin-bottom: 6px; display:block }
    .course-thumb { width: 60px; max-height: 40px; object-fit: cover; border-radius: 6px; margin-left: 8px }
    .thumb-box { width: 72px; height: 48px; border:1px solid #e5e7eb; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#fff; margin-left:8px }
    .actions { display: flex; gap: 8px; margin-top: 8px }
    .rf-container { background:#fff; border:1px solid #e5e7eb; border-radius:18px; overflow:hidden; box-shadow: 0 10px 24px rgba(0,0,0,.08) }
    .rf-header { background:#0c5a98; color:#fff; padding:20px; display:flex; gap:12px; align-items:center }
    .rf-header h2 { margin:0; font-size:20px }
    .rf-header p { margin:4px 0 0; opacity:.92 }
    .rf-grid { display:grid; grid-template-columns: 280px 1fr; gap:20px; padding:20px; align-items: start }
    .rf-fields { background:#fff; padding:14px; border-radius:12px; border:1px solid #e5e7eb }
    .rf-row { display:grid; grid-template-columns: 160px 1fr; gap:10px; align-items:center; margin-bottom:8px }
    .rf-plain-list { display:block }
    .rf-plain-item { display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #e5e7eb }
    .rf-row label { color:#0c5a98; font-weight:600; text-align:right; line-height:1.3; margin:0 }
    .rf-row input { background:#f5f7fa; border:1px solid #dbe0e6; border-radius:10px; padding:8px 10px; height:40px }
    .rf-row textarea { background:#f5f7fa; border:1px solid #dbe0e6; border-radius:10px; padding:10px; min-height:96px; line-height:1.5 }
    .rf-fields form { display: block; }
    .rf-status { display:flex; flex-direction:column; gap:10px }
    .rf-status-title { display:flex; align-items:center; gap:8px; color:#0c5a98; font-weight:700; margin-bottom:8px }
    .rf-check { display:flex; align-items:center; gap:8px; background:#e8e526; padding:12px; border-radius:10px; cursor:pointer }
    .rf-check input { width:16px; height:16px }
    .rf-multi { position:relative }
    .rf-multi-display { background:#f5f7fa; border:1px solid #dbe0e6; border-radius:10px; min-height:40px; padding:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap }
    .rf-tag { background:#0c5a98; color:#fff; border-radius:6px; padding:4px 8px; font-size:12px }
    .rf-dropdown { position:absolute; left:0; right:0; top:calc(100% + 4px); background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:220px; overflow:auto; display:none; z-index:50 }
    .rf-item { display:flex; align-items:center; gap:8px; padding:8px 10px; cursor:pointer }
    .rf-item:hover { background:#f3f4f6 }
    .container { max-width: 1100px; margin: 0 auto }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid #2f3e9e; background: #2f3e9e; color:#fff; cursor:pointer }
    .btn.btn-secondary { border-color: #e5e7eb; background:#fff; color:#111 }
    #toast { position: fixed; bottom: 16px; right: 16px; display: grid; gap: 8px; z-index: 20 }
    .toast { background:#111; color:#fff; padding: 10px 14px; border-radius: 10px; opacity: .95 }
    .toast.success { background: #16a34a }
    .toast.error { background: #dc2626 }
    @media (max-width: 900px) {
      .rf-grid { grid-template-columns: 1fr; }
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
      .rf-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <img src="/mehrab-logo.png" alt="MehrYar" onerror="this.src='/mehryar-logo.svg'" />
        <div class="brand-title">مهر یار - دستیار هوشمند آموزشگاه مهرابتکار</div>
      </div>
    </div>
  </header>
  <nav id="tabs" class="container"></nav>
  <main class="container">
    <section id="ApplicantsForm" class="rf">
      <div class="rf-container">
        <div class="rf-header">
          <div class="rf-header-icon"></div>
          <div>
            <h2>فرم ثبت نام مشتری</h2>
            <p>لطفاً اطلاعات خود را برای ثبت نام در دوره وارد کنید</p>
          </div>
        </div>
        <div class="rf-grid">
          <div class="rf-status">
            <button id="addApplicantBtn" class="btn" style="margin-bottom:10px">ثبت مشتری جدید</button>
          </div>
          <div class="rf-fields" id="applicantFormPanel" style="display:none">
          <form id="applicantForm">
            <div class="rf-row">
              <label>تاریخ روز</label>
              <div class="rf-multi" id="rfDatePicker">
                <input name="today" id="rfDate" type="text" placeholder="تاریخ شمسی (مثال: ۱۴۰۴/۰۹/۱۰)" />
                <div class="rf-dropdown" id="rfDateDropdown"></div>
              </div>
            </div>
            <div class="rf-row">
              <label>شماره تماس</label>
              <input name="phone" id="rfPhone" placeholder="09123456789" required />
            </div>
            <div class="rf-row">
              <label>نام مراجع</label>
              <input name="name" id="rfName" placeholder="اگر خالی باشد ناشناس درج می‌شود" required />
            </div>
            <div class="rf-row">
              <label>جنسیت</label>
              <select name="gender" id="rfGender">
                <option value="">-</option>
                <option value="male">آقا</option>
                <option value="female">خانم</option>
              </select>
            </div>
            <div class="rf-row">
              <label>نام دوره</label>
              <div class="rf-multi" id="rfCoursePicker">
                <div class="rf-multi-display" id="rfCourseDisplay">انتخاب دوره‌ها...</div>
                <input id="rfCourseSearch" placeholder="جستجوی دوره..." style="width:100%; padding:6px; border:1px solid #dbe0e6; border-radius:8px; margin:6px 0" />
                <div class="rf-dropdown" id="rfCourseDropdown"></div>
              </div>
            </div>
            <div class="rf-row">
              <label>نحوه آشنایی</label>
              <input name="familiarity" id="rfFamiliarity" placeholder="از چه طریقی آشنا شدید؟" />
            </div>
            <div class="rf-row">
              <label>توضیحات</label>
              <textarea name="note" id="rfNotes" placeholder="برای ارائه توضیحات درباره‌ی شخص" rows="4"></textarea>
            </div>

            <div class="rf-status" style="margin-top:12px; display:grid; grid-template-columns: repeat(2, 1fr); gap:10px">
              <div class="rf-status-title" style="grid-column: 1 / -1">وضعیت ثبت نام</div>
              <div class="rf-check"><input type="checkbox" id="chkComplete" /><label for="chkComplete">تکمیل ثبت نام</label></div>
              <div class="rf-check"><input type="checkbox" id="chkPreReg" /><label for="chkPreReg">ارسال فرم پیش ثبت نام</label></div>
              <div class="rf-check"><input type="checkbox" id="chkWaiting" /><label for="chkWaiting">منتظر خبر از متقاضی</label></div>
              <div class="rf-check"><input type="checkbox" id="chkNext" /><label for="chkNext">اطلاع از دوره های بعدی</label></div>
              <div class="rf-check"><input type="checkbox" id="chkCancel" /><label for="chkCancel">انصراف از ثبت نام</label></div>
              <div class="rf-check"><input type="checkbox" id="chkSendInfo" /><label for="chkSendInfo">ارسال اطلاعات دوره</label></div>
            </div>
            <input type="hidden" name="status" id="rfStatus" value="new" />
            <input type="hidden" name="id" id="rfApplicantId" />
            <div class="actions">
              <button type="submit" class="btn">ثبت</button>
              <button type="button" id="cancelApplicantForm" class="btn btn-secondary">انصراف</button>
            </div>
          </form>
          </div>
          </div>
          <div class="list">
          <h3>لیست متقاضیان</h3>
          <div style="margin-bottom:8px"><input id="applicantSearch" placeholder="جستجو..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
          <div id="applicantsList" class="rf-plain-list"></div>
          </div>
        </div>
    </section>

    <section id="TeachersForm" class="rf">
      <div class="rf-container">
        <div class="rf-header">
          <div class="rf-header-icon"></div>
          <div>
            <h2>مدرسین</h2>
            <p>مدیریت لیست مدرسین</p>
          </div>
        </div>
        <div class="rf-grid">
          <div class="rf-status">
            <button id="addTeacherBtn" class="btn">افزودن مدرس جدید</button>
          </div>
          <div class="rf-fields">
            <div class="list">
              <h3>لیست مدرسین</h3>
              <div style="margin-bottom:8px"><input id="teachersSearch" placeholder="جستجو مدرس..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
              <div id="teachersList" class="grid"></div>
            </div>
            <div id="teacherFormPanel" style="display:none; margin-top:12px">
              <form id="teacherForm">
                <div class="rf-row"><label>نام</label><input name="name" required /></div>
                <div class="rf-row"><label>شماره تماس</label><input name="phone" /></div>
                <div class="rf-row"><label>کد ملی</label><input name="national_id" /></div>
                <div class="rf-row"><label>دوره‌های قابل تدریس</label><input name="skills" placeholder="متن آزاد" /></div>
                <div class="rf-row"><label>توضیحات</label><input name="note" /></div>
                <input type="hidden" name="id" />
                <div class="actions">
                  <button type="submit" class="btn">ثبت</button>
                  <button type="button" id="cancelTeacherForm" class="btn btn-secondary">انصراف</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="CoursesForm" class="rf">
      <div class="rf-container">
        <div class="rf-header">
          <div class="rf-header-icon"></div>
          <div>
            <h2>دوره‌ها</h2>
            <p>مدیریت دوره‌های فنی و آموزشگاهی</p>
          </div>
        </div>
        <div class="rf-grid" style="grid-template-columns: 1fr 1fr">
          <div class="rf-fields">
            <h3 style="margin:0 0 8px; color:#0c5a98">دوره‌های فنی</h3>
            <div style="display:flex; gap:8px; margin-bottom:8px">
              <button id="addTechCourseBtn" class="btn">افزودن دوره فنی</button>
            </div>
            <div style="margin-bottom:8px"><input id="techCoursesSearch" placeholder="جستجوی دوره فنی..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
            <div id="techCoursesList"></div>
            <div id="techCourseFormPanel" style="display:none; margin-top:12px">
              <form id="techCourseForm">
                <div class="rf-row"><label>نام دوره (فارسی)</label><input name="name_fa" required /></div>
                <div class="rf-row"><label>نام دوره (انگلیسی)</label><input name="name_en" /></div>
                <div class="rf-row"><label>شهریه</label><input name="tuition" type="number" /></div>
                <div class="rf-row"><label>کد دوره</label><input name="code" /></div>
                <div class="rf-row"><label>ساعت دوره</label><input name="hours" type="number" /></div>
                <input type="hidden" name="id" />
                <div class="actions">
                  <button type="submit" class="btn">ثبت</button>
                  <button type="button" id="cancelTechCourseForm" class="btn btn-secondary">انصراف</button>
                </div>
              </form>
            </div>
          </div>
          <div class="rf-fields">
            <h3 style="margin:0 0 8px; color:#0c5a98">دوره‌های آموزشگاهی</h3>
            <div style="display:flex; gap:8px; margin-bottom:8px">
              <button id="addSchoolCourseBtn" class="btn">افزودن دوره آموزشگاهی</button>
            </div>
            <div style="margin-bottom:8px"><input id="schoolCoursesSearch" placeholder="جستجوی دوره آموزشگاهی..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
            <div id="schoolCoursesList"></div>
            <div id="schoolCourseFormPanel" style="display:none; margin-top:12px">
              <form id="schoolCourseForm">
                <div class="rf-row"><label>نام دوره</label><input name="name" required /></div>
                <div class="rf-row"><label>مدرس</label><input name="teacher" /></div>
                <div class="rf-row"><label>شهریه دوره</label><input name="tuition" id="schoolTuition" /></div>
                <div class="rf-row"><label>تعداد ساعت کلاس</label><input name="hour" id="schoolHour" /></div>
                <div class="rf-row"><label>تعداد جلسات</label><input name="sessions_count" id="schoolSessions" /></div>
                <div class="rf-row"><label>بنر دوره</label><input name="banner_file" id="schoolBannerFile" type="file" accept="image/*" /></div>
                <div id="schoolBannerPreview" style="margin-top:6px"></div>
                <input type="hidden" name="id" />
                <div class="actions">
                  <button type="submit" class="btn">ثبت</button>
                  <button type="button" id="cancelSchoolCourseForm" class="btn btn-secondary">انصراف</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="PreRegistrationForm" class="st">
      <div class="rf-container">
        <div class="rf-header">
          <div class="rf-header-icon"></div>
          <div>
            <h2>لیست شاگردان</h2>
            <p>افزودن و مدیریت اطلاعات شاگردان</p>
          </div>
        </div>
        <div class="rf-grid">
          <div class="rf-status">
            <button id="addStudentBtn" class="btn">افزودن شاگرد جدید</button>
          </div>
          <div class="rf-fields">
            <div class="st-form" id="studentFormPanel" style="margin-bottom:12px">
              <form id="studentForm">
                <div class="rf-row"><label>نام کامل</label><input name="full_name" placeholder="مثال: علی رضائی" required /></div>
                <div class="rf-row"><label>نام و نام خانوادگی (انگلیسی)</label><input name="english_name" /></div>
                <div class="rf-row"><label>شماره ملی</label><input name="national_id" maxlength="10" placeholder="10 رقم" /></div>
                <div class="rf-row"><label>شناسه دانشجویی</label><input name="student_id" readonly /></div>
                <div class="rf-row"><label>صادره از</label><input name="issuer" /></div>
                <div class="rf-row"><label>نام پدر</label><input name="father_name" /></div>
                <div class="rf-row"><label>نشانی</label><input name="address" /></div>
                <div class="rf-row"><label>شماره تماس</label><input name="phone" /></div>
                <div class="rf-row"><label>شماره تماس اضطراری</label><input name="emergency_phone" /></div>
                <div class="rf-row"><label>جنسیت</label>
                  <select name="gender">
                    <option value="">-</option>
                    <option value="male">آقا</option>
                    <option value="female">خانم</option>
                  </select>
                </div>
                <input type="hidden" name="id" />
                <div class="actions">
                  <button type="submit" class="btn">ثبت</button>
                  <button type="button" id="cancelStudentForm" class="btn btn-secondary">انصراف</button>
                </div>
              </form>
            </div>
            <div class="list">
              <h3>شاگردان</h3>
              <div style="margin-bottom:8px"><input id="studentsSearch" placeholder="جستجو..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
              <div id="studentsList" class="rf-plain-list"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="ClassesDashboard">
      <h2>کلاس‌ها</h2>
      <div class="actions">
        <button id="addClassBtn" class="btn">افزودن کلاس جدید</button>
      </div>
      <div style="margin:10px 0"><input id="classesSearch" placeholder="جستجو کلاس..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
      <div id="classesList" class="grid"></div>
      <div id="studentsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; width:90%; max-width:640px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
          <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee;">
            <h3 id="studentsModalTitle" style="margin:0">لیست شاگردان</h3>
            <button id="studentsModalClose" class="btn btn-secondary">بستن</button>
          </div>
          <div id="studentsModalBody" style="padding:12px 16px; max-height:60vh; overflow:auto"></div>
        </div>
      </div>
      <div id="classFormPanel" class="rf-fields" style="display:none; margin-top:12px">
        <form id="classForm">
          <div class="rf-row"><label>کد کلاس</label><input name="code" required /></div>
          <div class="rf-row"><label>نام دوره</label>
            <select name="course_id" id="clsCourse"></select>
          </div>
          
          <div class="rf-row"><label>تاریخ پایان دوره</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="clsEndJ" placeholder="yyyy/mm/dd" />
              <input name="end_date" id="clsEndG" type="hidden" />
            </div>
          </div>
          <div class="rf-row"><label>تاریخ صدور مدرک</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="clsCertJ" placeholder="yyyy/mm/dd" />
              <input name="certificate_issue_date" id="clsCertG" type="hidden" />
            </div>
          </div>
          <div class="rf-row"><label>مدرس</label>
            <div style="display:flex; gap:8px; align-items:center">
              <select name="teacher" id="clsTeacher"></select>
            </div>
          </div>
          <div class="rf-row"><label>ساعت کلاس</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="clsTimeFrom" placeholder="از" />
              <input id="clsTimeTo" placeholder="تا" />
            </div>
          </div>
          <div class="rf-row"><label>روزهای برگزاری</label>
            <div id="clsDays" style="display:flex; gap:8px; flex-wrap:wrap">
              <label><input type="checkbox" value="شنبه" /> شنبه</label>
              <label><input type="checkbox" value="یکشنبه" /> یکشنبه</label>
              <label><input type="checkbox" value="دوشنبه" /> دوشنبه</label>
              <label><input type="checkbox" value="سه‌شنبه" /> سه‌شنبه</label>
              <label><input type="checkbox" value="چهارشنبه" /> چهارشنبه</label>
              <label><input type="checkbox" value="پنجشنبه" /> پنجشنبه</label>
              <label><input type="checkbox" value="جمعه" /> جمعه</label>
            </div>
          </div>
          <div class="rf-row"><label>تعداد جلسات</label><input name="sessions_count" id="clsSessionsCount" type="number" min="1" value="1" /></div>
          <div class="rf-row"><label>لیست شاگردان</label>
            <div style="display:flex; flex-direction:column; gap:6px; width:100%">
              <button type="button" id="clsStudentsPicker" class="btn btn-secondary">انتخاب شاگردان...</button>
              <div id="clsStudentsDropdown" style="display:none; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa; padding:8px">
                <input id="clsStudentsSearch" placeholder="جستجوی شاگرد..." style="width:100%; padding:6px; border:1px solid #dbe0e6; border-radius:8px; margin-bottom:6px" />
                <div id="clsStudentsList"></div>
              </div>
              <div id="clsStudentsDisplay"></div>
            </div>
          </div>
          <div class="rf-row"><label>جلسات</label>
            <div id="clsSessions" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px"></div>
            <div class="actions"><button type="button" id="addMakeupSession" class="btn btn-secondary">افزودن جلسه جبرانی</button></div>
          </div>
          <div class="actions">
            <button type="submit" class="btn">ثبت کلاس</button>
            <button type="button" id="cancelClassForm" class="btn btn-secondary">انصراف</button>
          </div>
        </form>
      </div>
      <div class="list">
        <h3>ثبت حضور</h3>
        <button id="openAttendanceForm" class="btn btn-secondary" type="button">فرم ثبت حضور</button>
      </div>
    </section>

    <section id="AttendanceForm" class="rf">
      <div class="rf-container">
        <div class="rf-header">
          <div class="rf-header-icon"></div>
          <div>
            <h2>ثبت حضور</h2>
            <p>انتخاب کلاس و ثبت حضور جلسات به‌ازای هر شاگرد</p>
          </div>
        </div>
        <div class="rf-fields">
          <div class="rf-row"><label>کلاس</label>
            <select id="attClass"></select>
          </div>
          <div id="attGrid"></div>
          <div class="actions">
            <button id="attSubmit" class="btn">ثبت حضور</button>
            <button id="attCancel" class="btn btn-secondary" type="button">انصراف</button>
          </div>
        </div>
      </div>
    </section>

    <section id="FinanceDashboard">
      <h2>امور مالی</h2>
      <div class="actions">
        <button id="addStudentFinanceBtn" class="btn">افزودن پروفایل مالی جدید</button>
      </div>
      <div class="rf-fields" id="studentFinanceFormPanel" style="display:none; margin-top:12px">
        <form id="studentFinanceForm">
          <div class="rf-row"><label>نام شاگرد</label>
            <select name="student_id" id="sfStudent" required></select>
          </div>
          <div class="rf-row"><label>کد کلاس</label>
            <select name="class_code" id="sfClass" required></select>
          </div>
          <div class="rf-row"><label>مبلغ پیش‌پرداخت</label><input name="upfront_amount" id="sfUpfrontAmount" /></div>
          <div class="rf-row"><label>تاریخ پیش‌پرداخت</label><input name="upfront_date" id="sfUpfrontDate" type="date" /></div>
          <div class="rf-row"><label>اقساط</label>
            <div id="sfInstallments" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px"></div>
            <div class="actions"><button type="button" id="addInstallmentBtn" class="btn btn-secondary">افزودن قسط</button></div>
          </div>
          <div class="rf-row"><label>وضعیت تسویه</label>
            <select name="status" id="sfStatus">
              <option value="تسویه شده">تسویه شده</option>
              <option value="کنسل شده">کنسل شده</option>
              <option value="در انتظار تسویه" selected>در انتظار تسویه</option>
            </select>
          </div>
          <div class="actions">
            <button type="submit" class="btn">ثبت پروفایل مالی</button>
            <button type="button" id="cancelStudentFinanceForm" class="btn btn-secondary">انصراف</button>
          </div>
        </form>
      </div>
      <div class="list">
        <h3>پروفایل‌های مالی شاگردان</h3>
        <div style="margin-bottom:8px"><input id="studentFinanceSearch" placeholder="جستجو پروفایل..." style="width:100%; padding:8px; border:1px solid #dbe0e6; border-radius:10px; background:#f5f7fa" /></div>
        <div id="studentFinanceList" class="grid"></div>
      </div>
    </section>

    
    <section id="CertIssuance" class="rf">
      <div class="rf-container">
        <div class="rf-header">
          <div class="rf-header-icon"></div>
          <div>
            <h2>صدور گواهینامه</h2>
            <p>ساخت دوره مدارک و افزودن شاگردان برای صدور</p>
          </div>
        </div>
        <div class="rf-grid">
          <div class="rf-status">
            <button id="addCertCourseBtn" class="btn">افزودن دوره‌ی مدارک جدید</button>
          </div>
          <div class="rf-fields" id="certCoursePanel" style="display:none">
            <div class="actions">
              <button id="addCertStudentBtn" class="btn btn-secondary" type="button">افزودن شاگرد</button>
              <button id="exportCertDocBtn" class="btn" type="button">خروجی ورد</button>
            </div>
            <div id="certEntries" class="list">
              <h3>شاگردان برای صدور مدرک</h3>
              <div id="certList" class="grid"></div>
            </div>
            <div id="certStudentFormPanel" style="display:none; margin-top:12px">
              <form id="certStudentForm">
                <div class="rf-row"><label>نام شاگرد</label><select id="certStudentSelect" required></select></div>
                <div class="rf-row"><label>نام لاتین شاگرد</label><input id="certStudentEnglish" readonly /></div>
                <div class="rf-row"><label>شناسه دانشجویی</label><input id="certStudentId" readonly /></div>
                <div class="rf-row"><label>کد ملی</label><input id="certNationalId" readonly /></div>
                <div class="rf-row"><label>صادره از</label><input id="certIssuer" readonly /></div>
                <div class="rf-row"><label>کد کلاس</label><select id="certClassSelect" required></select></div>
                <div class="rf-row"><label>نام دوره</label><input id="certCourseName" readonly /></div>
                <div class="rf-row"><label>نام لاتین دوره</label><input id="certCourseEnglish" readonly /></div>
                <div class="rf-row"><label>تعداد ساعت دوره</label><input id="certCourseHours" readonly /></div>
                <div class="rf-row"><label>تاریخ پایان دوره</label><input id="certEndDate" readonly /></div>
                <div class="rf-row"><label>تاریخ صدور مدرک</label><input id="certIssueDate" readonly /></div>
                <div class="actions"><button type="submit" class="btn">افزودن</button><button id="cancelCertStudentForm" type="button" class="btn btn-secondary">انصراف</button></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="DataLinksManager">
      <h2>List Box لینک‌های Google Sheet</h2>
      <form id="linksForm"></form>
      <div class="list">
        <h3>لینک‌های فعال</h3>
        <div id="linksView"></div>
      </div>
    </section>
  </main>
  <div id="toast" aria-live="polite" aria-atomic="true"></div>
  <script>
    const tabs = [
      { id: "ApplicantsForm", label: "فرم ورودی" },
      { id: "PreRegistrationForm", label: "لیست شاگردان" },
      { id: "ClassesDashboard", label: "کلاس‌ها" },
      { id: "FinanceDashboard", label: "مالی" },
      { id: "CoursesForm", label: "دوره‌ها" },
      { id: "TeachersForm", label: "مدرسین" },
      { id: "CertIssuance", label: "صدور گواهینامه" }
    ];
    const nav = document.getElementById("tabs");
    const main = document.querySelector("main");
    tabs.forEach(t => {
      const b = document.createElement("button");
      b.textContent = t.label;
      b.dataset.id = t.id;
      b.onclick = () => activate(t.id);
      nav.appendChild(b);
    });
    function activate(id) {
      document.querySelectorAll("nav button").forEach(b => b.classList.toggle("active", b.dataset.id === id));
      document.querySelectorAll("section").forEach(s => s.classList.toggle("active", s.id === id));
    }
    activate(tabs[0].id);
    function showToast(text, type = "success") {
      const box = document.getElementById("toast");
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.textContent = text;
      box.appendChild(el);
      setTimeout(() => { el.remove(); }, 2500);
    }
    async function postWebhook(type, payload){
      try {
        await fetch("https://33499-il9bs.irann8n.com/webhook/e46e7fbf-e6eb-4008-9516-016957e65d89", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type, payload })
        });
      } catch {}
    }
    const applicantForm = document.getElementById("applicantForm");
    const addApplicantBtn = document.getElementById("addApplicantBtn");
    const applicantFormPanel = document.getElementById("applicantFormPanel");
    const cancelApplicantForm = document.getElementById("cancelApplicantForm");
    function openApplicantForm(){ applicantFormPanel.style.display = "block"; }
    function closeApplicantForm(){ applicantFormPanel.style.display = "none"; }
    addApplicantBtn.addEventListener("click", openApplicantForm);
    cancelApplicantForm.addEventListener("click", closeApplicantForm);
    applicantForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(applicantForm);
      const payload = Object.fromEntries(fd.entries());
      payload.name = (payload.name || "").trim() || "ناشناس";
      payload.phone = (payload.phone || "").trim();
      payload.course = (window.selectedCourses || []).join(", ");
      const statusOrder = [
        { el: document.getElementById("chkComplete"), val: "registration_complete" },
        { el: document.getElementById("chkPreReg"), val: "to_pre_registration" },
        { el: document.getElementById("chkWaiting"), val: "waiting_applicant" },
        { el: document.getElementById("chkNext"), val: "next_courses_info" },
        { el: document.getElementById("chkCancel"), val: "cancelled" },
        { el: document.getElementById("chkSendInfo"), val: "send_course_info" }
      ];
      const found = statusOrder.find(s => s.el && s.el.checked);
      payload.status = found ? found.val : (payload.status || "new");
      payload.complete = !!document.getElementById("chkComplete")?.checked;
      payload.pre_register = !!document.getElementById("chkPreReg")?.checked;
      payload.waiting_applicant = !!document.getElementById("chkWaiting")?.checked;
      payload.next_courses_info = !!document.getElementById("chkNext")?.checked;
      payload.cancelled = !!document.getElementById("chkCancel")?.checked;
      payload.send_course_info = !!document.getElementById("chkSendInfo")?.checked;
      const isEdit = !!payload.id;
      if (!isEdit) {
        try {
          const res = await fetch("/api/applicants", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          const json = await res.json().catch(() => ({ ok: false }));
          if (json?.ok) { await postWebhook("applicant_submit", json.applicant || payload); showToast("ثبت مشتری انجام شد", "success"); }
          else { showToast(`خطا در ثبت مشتری${json?.error ? `: ${json.error}` : ""}`, "error"); }
        } catch { showToast("خطا در اتصال", "error"); }
      } else {
        try {
          const res = await fetch(`/api/applicants/${payload.id}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          const json = await res.json().catch(() => ({ ok: false }));
          if (json?.ok) { await postWebhook("applicant_update", json.applicant || payload); showToast("متقاضی ویرایش شد", "success"); }
          else { showToast(`خطا در ویرایش متقاضی${json?.error ? `: ${json.error}` : ""}`, "error"); }
        } catch { showToast("خطا در اتصال", "error"); }
      }
      loadApplicants();
    });
    const rfDate = document.getElementById("rfDate");
    const rfDateDropdown = document.getElementById("rfDateDropdown");
    function toFaDigits(s){
      const map = {"0":"۰","1":"۱","2":"۲","3":"۳","4":"۴","5":"۵","6":"۶","7":"۷","8":"۸","9":"۹"};
      return String(s).replace(/[0-9]/g, d => map[d]);
    }
    function fromFaDigits(s){
      const map = {"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"};
      return String(s).replace(/[۰-۹]/g, d => map[d] || d);
    }
    function pad2(n){ return String(n).padStart(2, "0"); }
    function g2j(gy, gm, gd){
      gy = +gy; gm = +gm; gd = +gd;
      const g_d_m = [0,31, (gy%4==0&&gy%100!=0)||gy%400==0?29:28,31,30,31,30,31,31,30,31,30,31];
      let gy2 = gy-1600; let gm2 = gm-1; let gd2 = gd-1;
      let g_day_no = 365*gy2 + Math.floor((gy2+3)/4) - Math.floor((gy2+99)/100) + Math.floor((gy2+399)/400);
      for(let i=0;i<gm2;i++) g_day_no += g_d_m[i+1];
      g_day_no += gd2;
      let j_day_no = g_day_no-79;
      const j_np = Math.floor(j_day_no/12053);
      j_day_no %= 12053;
      let jy = 979 + 33*j_np + 4*Math.floor(j_day_no/1461);
      j_day_no %= 1461;
      if (j_day_no >= 366) jy += Math.floor((j_day_no-366)/365);
      const jm = j_day_no<=185 ? 1+Math.floor(j_day_no/31) : 7+Math.floor((j_day_no-186)/30);
      const jd = j_day_no<=185 ? 1+(j_day_no%31) : 1+((j_day_no-186)%30);
      return [jy,jm,jd];
    }
    function jLeap(jy){ return (((jy-474)%2820)+474+38)*682%2816 < 682; }
    function jMonthLen(jy,jm){ if (jm<=6) return 31; if (jm<=11) return 30; return jLeap(jy)?30:29; }
    function j2g(jy, jm, jd){
      jy = +jy; jm = +jm; jd = +jd;
      jy -= 979; let j_day_no = 365*jy + Math.floor(jy/33)*8 + Math.floor(((jy%33)+3)/4);
      for(let i=0;i<jm-1;i++) j_day_no += (i<6?31:30);
      j_day_no += jd-1;
      let g_day_no = j_day_no + 79;
      let gy = 1600 + 400*Math.floor(g_day_no/146097); g_day_no %= 146097;
      let leap = true;
      if (g_day_no >= 36525){ g_day_no--; gy += 100*Math.floor(g_day_no/36524); g_day_no %= 36524; leap = g_day_no >= 365; }
      gy += 4*Math.floor(g_day_no/1461); g_day_no %= 1461;
      if (g_day_no >= 366){ leap = false; g_day_no--; gy += Math.floor(g_day_no/365); g_day_no %= 365; }
      const g_md = [0,31, (leap?29:28),31,30,31,30,31,31,30,31,30,31];
      let gm = 0; for(gm=1; gm<=12 && g_day_no >= g_md[gm]; gm++){ g_day_no -= g_md[gm]; }
      const gd = g_day_no+1; return [gy,gm,gd];
    }
    const weekDays = ["شنبه","یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه","پنجشنبه","جمعه"];
    const monthsFa = ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"];
    let curJ = (() => { const d=new Date(); const [jy,jm,jd]=g2j(d.getFullYear(), d.getMonth()+1, d.getDate()); return {jy,jm,jd}; })();
    function renderJalaliCalendar(){
      rfDateDropdown.innerHTML = "";
      const header = document.createElement("div"); header.style.display="flex"; header.style.justifyContent="space-between"; header.style.alignItems="center"; header.style.padding="8px";
      const prev = document.createElement("button"); prev.className="btn btn-secondary"; prev.textContent="<"; prev.onclick = () => { curJ.jm--; if (curJ.jm<1){ curJ.jm=12; curJ.jy--; } renderJalaliCalendar(); };
      const next = document.createElement("button"); next.className="btn btn-secondary"; next.textContent=">"; next.onclick = () => { curJ.jm++; if (curJ.jm>12){ curJ.jm=1; curJ.jy++; } renderJalaliCalendar(); };
      const title = document.createElement("div"); const mi = Math.max(1, Math.min(12, Number(curJ.jm||1))) - 1; title.textContent = `${monthsFa[mi]} ${toFaDigits(curJ.jy)}`;
      header.appendChild(prev); header.appendChild(title); header.appendChild(next);
      rfDateDropdown.appendChild(header);
      const grid = document.createElement("div"); grid.style.display="grid"; grid.style.gridTemplateColumns="repeat(7, 1fr)"; grid.style.gap="6px"; grid.style.padding="8px";
      weekDays.forEach(w => { const c=document.createElement("div"); c.textContent=w; c.style.fontWeight="600"; c.style.textAlign="center"; grid.appendChild(c); });
      const firstG = j2g(curJ.jy, curJ.jm, 1); const firstDay = new Date(firstG[0], firstG[1]-1, firstG[2]).getDay();
      const offset = (firstDay + 1) % 7;
      for(let i=0;i<offset;i++){ const e=document.createElement("div"); grid.appendChild(e); }
      const ml = jMonthLen(curJ.jy, curJ.jm);
      for(let d=1; d<=ml; d++){
        const cell = document.createElement("button"); cell.className="btn btn-secondary"; cell.style.padding="6px"; cell.textContent = toFaDigits(pad2(d));
        cell.onclick = () => { rfDate.value = `${toFaDigits(pad2(d))}/${toFaDigits(pad2(curJ.jm))}/${toFaDigits(curJ.jy)}`; rfDateDropdown.style.display="none"; };
        grid.appendChild(cell);
      }
      rfDateDropdown.appendChild(grid);
    }
    if (rfDate) {
      const now = new Date(); const [jy,jm,jd] = g2j(now.getFullYear(), now.getMonth()+1, now.getDate());
      rfDate.value = `${toFaDigits(pad2(jd))}/${toFaDigits(pad2(jm))}/${toFaDigits(jy)}`;
      rfDate.addEventListener("click", () => {
        const visible = rfDateDropdown.style.display === "block";
        rfDateDropdown.style.display = visible ? "none" : "block";
        renderJalaliCalendar();
      });
    }
    window.selectedCourses = [];
    const rfCoursePicker = document.getElementById("rfCoursePicker");
    const rfCourseDisplay = document.getElementById("rfCourseDisplay");
    const rfCourseDropdown = document.getElementById("rfCourseDropdown");
    const rfCourseSearch = document.getElementById("rfCourseSearch");
    function addClearButton(el, onClear){
      if (!el) return;
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-secondary";
      btn.textContent = "حذف";
      btn.style.padding = "6px 10px";
      btn.style.height = "34px";
      btn.style.marginInlineStart = "8px";
      btn.onclick = onClear;
      el.insertAdjacentElement("afterend", btn);
    }
    function renderSelectedCourses() {
      if (!rfCourseDisplay) return;
      rfCourseDisplay.innerHTML = "";
      if (!window.selectedCourses.length) {
        rfCourseDisplay.textContent = "انتخاب دوره‌ها...";
        return;
      }
      window.selectedCourses.forEach(c => {
        const tag = document.createElement("span");
        tag.className = "rf-tag";
        tag.textContent = c;
        rfCourseDisplay.appendChild(tag);
      });
    }
    function toggleCourse(name) {
      const arr = window.selectedCourses;
      const idx = arr.indexOf(name);
      if (idx >= 0) arr.splice(idx, 1); else arr.push(name);
      renderSelectedCourses();
    }
    rfCoursePicker.addEventListener("click", () => {
      const visible = rfCourseDropdown.style.display === "block";
      rfCourseDropdown.style.display = visible ? "none" : "block";
    });
    function renderCourseDropdown(items){
      rfCourseDropdown.innerHTML = "";
      items.forEach(c => {
        const row = document.createElement("div");
        row.className = "rf-item";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = window.selectedCourses.includes(c.name);
        cb.onchange = () => toggleCourse(c.name);
        const label = document.createElement("span");
        label.textContent = `${c.name}`;
        row.appendChild(cb);
        row.appendChild(label);
        row.onclick = () => { cb.checked = !cb.checked; toggleCourse(c.name); };
        rfCourseDropdown.appendChild(row);
      });
    }
    async function loadCourses() {
      const res = await fetch("/api/courses");
      const items = await res.json();
      window.coursesData = items;
      renderCourseDropdown(items);
      renderSelectedCourses();
    }
    loadCourses();
    rfCourseSearch?.addEventListener("input", () => {
      const q = (rfCourseSearch.value || "").trim();
      const filtered = q ? (window.coursesData||[]).filter(c => String(c.name||"").includes(q)) : (window.coursesData||[]);
      renderCourseDropdown(filtered);
    });
    const applicantSearch = document.getElementById("applicantSearch");
    function renderApplicants(items){
      const list = document.getElementById("applicantsList");
      const q = (applicantSearch?.value || "").trim();
      const filtered = q ? items.filter(x => `${x.name||""} ${x.phone||""} ${x.course||""}`.includes(q)) : items;
      list.innerHTML = "";
      filtered.forEach(x => {
        const c = document.createElement("div");
        c.className = "rf-plain-item";
        const title = document.createElement("div");
        title.textContent = `${x.name||""} | ${x.phone||""} | ${x.course||""}`;
        const actions = document.createElement("div");
        actions.className = "actions";
        actions.style.marginTop = "0";
        const addBtn = document.createElement("button");
        addBtn.className = "btn btn-secondary";
        addBtn.textContent = "افزودن به لیست شاگردان";
        addBtn.onclick = async () => {
          const payload = { name: (x.name||"").trim() || "ناشناس", phone: (x.phone||"").trim(), status: "active" };
          try {
            const res = await fetch("/api/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            const json = await res.json().catch(() => ({ ok:false }));
            showToast(json.ok ? "شاگرد اضافه شد" : `خطا در افزودن${json?.error?`: ${json.error}`:""}`, json.ok ? "success" : "error");
            if (json.ok) { try { await loadStudents(); } catch {} }
          } catch { showToast("خطا در اتصال", "error"); }
        };
        const editBtn = document.createElement("button");
        editBtn.className = "btn";
        editBtn.textContent = "ویرایش";
        editBtn.onclick = () => {
          openApplicantForm();
          document.getElementById("rfApplicantId").value = x.id || "";
          { const d=new Date(); const [jy,jm,jd]=g2j(d.getFullYear(), d.getMonth()+1, d.getDate()); document.getElementById("rfDate").value = `${toFaDigits(String(jd).padStart(2,"0"))}/${toFaDigits(String(jm).padStart(2,"0"))}/${toFaDigits(jy)}`; }
          document.getElementById("rfName").value = x.name || "";
          document.getElementById("rfPhone").value = x.phone || "";
          document.getElementById("rfFamiliarity").value = x.familiarity || "";
          document.getElementById("rfNotes").value = x.note || "";
          document.getElementById("rfStatus").value = x.status || "new";
          const setCB = (id, val) => { const el = document.getElementById(id); if (el) el.checked = !!val; };
          setCB("chkComplete", x.complete);
          setCB("chkPreReg", x.pre_register);
          setCB("chkWaiting", x.waiting_applicant);
          setCB("chkNext", x.next_courses_info);
          setCB("chkCancel", x.cancelled);
          setCB("chkSendInfo", x.send_course_info);
        };
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-secondary";
        delBtn.textContent = "حذف";
        delBtn.onclick = async () => {
          if (!x.id) { showToast("شناسه نامعتبر", "error"); return; }
          try {
            const res = await fetch(`/api/applicants/${x.id}`, { method: "DELETE" });
            const json = await res.json().catch(() => ({ ok:false }));
            showToast(json.ok ? "متقاضی حذف شد" : "خطا در حذف", json.ok ? "success" : "error");
            loadApplicants();
          } catch { showToast("خطا در اتصال", "error"); }
        };
        actions.appendChild(addBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        c.appendChild(title);
        c.appendChild(actions);
        list.appendChild(c);
      });
    }
    applicantSearch?.addEventListener("input", () => renderApplicants(window.applicantsData||[]));
    async function loadApplicants() {
      const res = await fetch("/api/applicants");
      const items = await res.json();
      window.applicantsData = items;
      renderApplicants(items);
    }
    loadApplicants();
    const preRegForm = document.getElementById("preRegForm");
    const paymentResult = document.getElementById("paymentResult");
    // Students UI
    const addStudentBtn = document.getElementById("addStudentBtn");
    const studentsList = document.getElementById("studentsList");
    const studentsSearch = document.getElementById("studentsSearch");
    const studentFormPanel = document.getElementById("studentFormPanel");
    const studentForm = document.getElementById("studentForm");
    const cancelStudentForm = document.getElementById("cancelStudentForm");
    function openStudentForm(data = null) {
      studentForm.reset();
      const nationalInput = studentForm.querySelector('[name="national_id"]');
      const studentIdInput = studentForm.querySelector('[name="student_id"]');
      if (data) {
        Object.entries(data).forEach(([k, v]) => {
          const el = studentForm.querySelector(`[name="${k}"]`);
          if (el) el.value = v || "";
        });
        const fullEl = studentForm.querySelector('[name="full_name"]');
        if (fullEl) fullEl.value = [data.name, data.last_name].filter(Boolean).join(" ");
        if (data.national_id && studentIdInput) {
          const raw = String(data.national_id).replace(/\D/g, "");
          if (raw.length === 10) studentIdInput.value = raw.replace(/^0+/, "");
        }
      }
      studentFormPanel.style.display = "block";
      document.getElementById("PreRegistrationForm")?.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    function closeStudentForm() { studentFormPanel.style.display = "none"; }
    addStudentBtn.addEventListener("click", () => openStudentForm());
    cancelStudentForm.addEventListener("click", closeStudentForm);
    function renderStudents(items){
      const q = (studentsSearch?.value || "").trim();
      const filtered = q ? items.filter(x => `${(x.full_name||"")} ${(x.name||"")} ${(x.last_name||"")} ${(x.phone||"")} ${(x.student_id||"")}`.includes(q)) : items;
      studentsList.innerHTML = "";
      filtered.forEach(x => {
        const full = (x.name && String(x.name).trim()) || (x.full_name && String(x.full_name).trim()) || (x.english_name||"");
        const title = full || "بدون نام";
        const c = document.createElement("div");
        c.className = "rf-plain-item";
        const info = document.createElement("div");
        info.textContent = `${title} | ${x.phone || ""} ${x.student_id ? `| ${x.student_id}` : ""}`;
        const actions = document.createElement("div");
        actions.className = "actions";
        actions.style.marginTop = "0";
        const edit = document.createElement("button");
        edit.className = "btn";
        edit.textContent = "ویرایش";
        edit.onclick = () => openStudentForm(x);
        const del = document.createElement("button");
        del.className = "btn btn-secondary";
        del.textContent = "حذف";
        del.onclick = async () => {
          if (!x.id) { showToast("شناسه نامعتبر", "error"); return; }
          const res = await fetch(`/api/students/${x.id}`, { method: "DELETE" });
          const json = await res.json().catch(()=>({ ok:false }));
          showToast(json.ok?"شاگرد حذف شد":"خطا در حذف", json.ok?"success":"error");
          loadStudents();
        };
        const fin = document.createElement("button");
        fin.className = "btn btn-secondary";
        fin.textContent = "پروفایل مالی";
        fin.onclick = () => {
          activate("FinanceDashboard");
          const id = x.id || x.student_id || "";
          const s = document.getElementById("studentFinanceSearch");
          if (s) { s.value = id; renderStudentFinance(window.studentFinanceData||[]); }
          document.getElementById("FinanceDashboard")?.scrollIntoView({ behavior: "smooth", block: "start" });
        };
        c.appendChild(info);
        actions.appendChild(edit);
        actions.appendChild(del);
        actions.appendChild(fin);
        c.appendChild(actions);
        studentsList.appendChild(c);
      });
    }
    studentsSearch?.addEventListener("input", () => renderStudents(window.studentsData||[]));
    async function loadStudents() {
      const res = await fetch("/api/students");
      const items = await res.json();
      window.studentsData = items;
      renderStudents(items);
    }
    loadStudents();
    studentForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(studentForm);
      const obj = Object.fromEntries(fd.entries());
      const parts = String(obj.full_name||"").trim().split(/\s+/);
      const first = parts.shift() || "";
      const rest = parts.join(" ");
      const payload = { ...obj, name: first, last_name: rest };
      delete payload.full_name;
      const nraw = String(payload.national_id || "").replace(/\D/g, "");
      if (nraw.length === 10) payload.student_id = nraw.replace(/^0+/, "");
      const id = payload.id;
      let res;
      if (id) {
        res = await fetch(`/api/students/${id}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      } else {
        res = await fetch("/api/students", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      }
      const json = await res.json().catch(()=>({ ok:false }));
      if (json?.ok) { await postWebhook(id?"student_update":"student_submit", json.student || payload); }
      const msg = json.ok ? (id ? "شاگرد به‌روزرسانی شد" : "شاگرد اضافه شد") : `خطا در ثبت${json?.error?`: ${json.error}`:""}`;
      showToast(msg, json.ok ? "success" : "error");
      if (json.ok) { closeStudentForm(); loadStudents(); }
    });

    // Auto-fill student_id from national_id, enforce 10 digits and trim leading zeros
    (function attachNationalAuto(){
      const nationalInput = studentForm.querySelector('[name="national_id"]');
      const studentIdInput = studentForm.querySelector('[name="student_id"]');
      if (!nationalInput || !studentIdInput) return;
      nationalInput.addEventListener('input', () => {
        const raw = nationalInput.value.replace(/\D/g, '');
        if (raw.length > 10) nationalInput.value = raw.slice(0,10);
        else nationalInput.value = raw;
        if (raw.length === 10) studentIdInput.value = raw.replace(/^0+/, '');
        else studentIdInput.value = '';
      });
    })();
    // بارگذاری خودکار کلاس‌ها بدون دکمه
    loadClasses();
    const addClassBtn = document.getElementById("addClassBtn");
    const classFormPanel = document.getElementById("classFormPanel");
    const classForm = document.getElementById("classForm");
    const cancelClassForm = document.getElementById("cancelClassForm");
    const classesSearch = document.getElementById("classesSearch");
    function openClassForm(){ classForm.reset(); classFormPanel.style.display = "block"; renderSessionBoxes(); loadTeacherOptions(); attachJalaliPickers(); }
    function closeClassForm(){ classFormPanel.style.display = "none"; }
    addClassBtn.addEventListener("click", openClassForm);
    cancelClassForm.addEventListener("click", closeClassForm);
    const clsCourse = document.getElementById("clsCourse");
    async function loadCourseOptions(){
      const [schoolRes, techRes] = await Promise.all([fetch("/api/courses"), fetch("/api/tech-courses")]);
      const school = await schoolRes.json();
      const tech = await techRes.json();
      clsCourse.innerHTML = "";
      school.forEach(c => { const opt = document.createElement("option"); opt.value = c.id || c.name; opt.textContent = `آموزشگاهی: ${c.name}`; opt.dataset.sessions = c.sessions_count || 0; clsCourse.appendChild(opt); });
      tech.forEach(c => { const opt = document.createElement("option"); opt.value = c.id || c.name_fa; opt.textContent = `فنی: ${c.name_fa}`; opt.dataset.sessions = 0; clsCourse.appendChild(opt); });
      const clsTechCode = document.getElementById("clsTechCode");
      if (clsTechCode) {
        clsTechCode.innerHTML = "";
        tech.forEach(c => { const opt = document.createElement("option"); opt.value = c.code || ""; opt.textContent = `${c.code || ""} - ${c.name_fa || ""}`; clsTechCode.appendChild(opt); });
      }
    }
    loadCourseOptions();
    const clsTeacher = document.getElementById("clsTeacher");
    async function loadTeacherOptions(){
      const res = await fetch("/api/teachers");
      const items = await res.json();
      if (!clsTeacher) return;
      clsTeacher.innerHTML = "";
      items.forEach(t => { const opt = document.createElement("option"); opt.value = t.name || ""; opt.textContent = `${t.name || ""}`; clsTeacher.appendChild(opt); });
    }
    const clsSessionsCount = document.getElementById("clsSessionsCount");
    const clsSessions = document.getElementById("clsSessions");
    function formatFa(n){ return String(n).replace(/[0-9]/g, d => "۰۱۲۳۴۵۶۷۸۹"[Number(d)]); }
    function pad2(n){ return String(n).padStart(2, "0"); }
    function attachJalaliPickers(){
      const defs = [
        { j: document.getElementById("clsEndJ"), g: document.getElementById("clsEndG") },
        { j: document.getElementById("clsCertJ"), g: document.getElementById("clsCertG") }
      ];
      const parseJ = (val) => {
        const v = fromFaDigits(String(val||""));
        const m = v.match(/^\s*(\d{4})\/(\d{1,2})\/(\d{1,2})\s*$/);
        if (!m) return null;
        const jy = Number(m[1]), jm = Number(m[2]), jd = Number(m[3]);
        if (!jy || jm<1 || jm>12 || jd<1 || jd>31) return null;
        return { jy, jm, jd };
      };
      defs.forEach(def => {
        if (!def.j || !def.g) return;
        def.j.addEventListener("input", () => {
          const p = parseJ(def.j.value);
          if (!p) { def.g.value = ""; return; }
          const [gy,gm,gd] = j2g(p.jy, p.jm, p.jd);
          def.g.value = `${gy}-${pad2(gm)}-${pad2(gd)}`;
        });
      });
    }
    let makeupList = [];
    function renderSessionBoxes(){
      const n = Math.max(1, Number(clsSessionsCount.value || 1));
      clsSessions.innerHTML = "";
      makeupList = [];
      for(let i=1;i<=n;i++){
        const box = document.createElement("div");
        box.className = "card";
        const di = document.createElement("input"); di.type = "text"; di.name = `session_date_${i}`; di.placeholder = "yyyy/mm/dd";
        const gi = document.createElement("input"); gi.type = "hidden"; gi.name = `session_date_g_${i}`;
        const c1 = document.createElement("label");
        const c1i = document.createElement("input"); c1i.type = "checkbox"; c1i.name = `session_cancel_${i}`; c1.appendChild(c1i); c1.appendChild(document.createTextNode(" کنسلی جلسه"));
        box.appendChild(document.createTextNode(`جلسه ${i}`));
        box.appendChild(document.createElement("br"));
        box.appendChild(di);
        box.appendChild(gi);
        box.appendChild(document.createElement("br"));
        box.appendChild(c1);
        clsSessions.appendChild(box);
      }
      attachSessionJalaliPickers();
    }
    clsSessionsCount.addEventListener("input", renderSessionBoxes);
    clsCourse.addEventListener("change", () => { const s = Number(clsCourse.selectedOptions[0]?.dataset.sessions || 0); if (s>0){ clsSessionsCount.value = s; renderSessionBoxes(); } });
    function propagateSessionDates(){
      const firstGVal = document.querySelector('[name="session_date_g_1"]').value;
      const firstJEl = document.querySelector('[name="session_date_1"]');
      const daysChecked = Array.from(document.querySelectorAll('#clsDays input[type="checkbox"]:checked')).map(i=>i.value);
      const dayMap = { "یکشنبه":0, "دوشنبه":1, "سه‌شنبه":2, "چهارشنبه":3, "پنجشنبه":4, "جمعه":5, "شنبه":6 };
      const wanted = daysChecked.map(d=>dayMap[d]).filter(v=>v!==undefined);
      const parseJ = (val) => {
        const v = fromFaDigits(String(val||""));
        const m = v.match(/^\s*(\d{4})\/(\d{1,2})\/(\d{1,2})\s*$/);
        if (!m) return null;
        const jy = Number(m[1]), jm = Number(m[2]), jd = Number(m[3]);
        if (!jy || jm<1 || jm>12 || jd<1 || jd>31) return null;
        return { jy, jm, jd };
      };
      const jMonthCap = (jy,jm) => jm<=6?31:(jm<=11?30:29);
      const jNextDay = (jy,jm,jd) => {
        const cap = jMonthCap(jy,jm);
        jd++;
        if (jd>cap){ jd=1; jm++; if (jm>12){ jm=1; jy++; } }
        return { jy, jm, jd };
      };
      let curJ = null;
      if (firstJEl && firstJEl.value){ curJ = parseJ(firstJEl.value); }
      if (!curJ && firstGVal){ const [jy,jm,jd] = g2j(new Date(firstGVal).getFullYear(), new Date(firstGVal).getMonth()+1, new Date(firstGVal).getDate()); curJ = { jy, jm, jd }; }
      if (!curJ) return;
      const n = Math.max(1, Number(clsSessionsCount.value||1));
      let count = 1;
      while(count < n){
        curJ = jNextDay(curJ.jy, curJ.jm, curJ.jd);
        const gParts = j2g(curJ.jy, curJ.jm, curJ.jd);
        const gd = new Date(gParts[0], gParts[1]-1, gParts[2]);
        if (wanted.includes(gd.getDay())){
          count++;
          const idx = count;
          const inp = document.querySelector(`[name="session_date_${idx}"]`);
          const ginp = document.querySelector(`[name="session_date_g_${idx}"]`);
          if (inp) inp.value = `${curJ.jy}/${pad2(curJ.jm)}/${pad2(curJ.jd)}`;
          if (ginp) ginp.value = `${gParts[0]}-${pad2(gParts[1])}-${pad2(gParts[2])}`;
        }
      }
    }
    const addMakeupSession = document.getElementById("addMakeupSession");
    addMakeupSession?.addEventListener("click", ()=>{
      const idx = makeupList.length + 1;
      const box = document.createElement("div"); box.className = "card";
      box.appendChild(document.createTextNode(`جلسه جبرانی ${idx}`)); box.appendChild(document.createElement("br"));
      const di = document.createElement("input"); di.type = "text"; di.name = `makeup_date_${idx}`; di.placeholder = "yyyy/mm/dd"; box.appendChild(di);
      const gi = document.createElement("input"); gi.type = "hidden"; gi.name = `makeup_date_g_${idx}`; box.appendChild(gi);
      box.appendChild(document.createElement("br"));
      const c1 = document.createElement("label"); const c1i = document.createElement("input"); c1i.type = "checkbox"; c1i.name = `makeup_cancel_${idx}`; c1.appendChild(c1i); c1.appendChild(document.createTextNode(" کنسلی جلسه")); box.appendChild(c1);
      clsSessions.appendChild(box);
      makeupList.push(idx);
      attachSessionJalaliPickers();
    });

    function attachSessionJalaliPickers(){
      const n = Math.max(1, Number(clsSessionsCount.value || 1));
      const parseJ = (val) => {
        const v = fromFaDigits(String(val||""));
        const m = v.match(/^\s*(\d{4})\/(\d{1,2})\/(\d{1,2})\s*$/);
        if (!m) return null;
        const jy = Number(m[1]), jm = Number(m[2]), jd = Number(m[3]);
        if (!jy || jm<1 || jm>12 || jd<1 || jd>31) return null;
        return { jy, jm, jd };
      };
      for(let i=1;i<=n;i++){
        const j = document.querySelector(`[name="session_date_${i}"]`);
        const g = document.querySelector(`[name="session_date_g_${i}"]`);
        if (j && g){
          j.addEventListener("input", () => {
            const p = parseJ(j.value);
            if (!p) { g.value = ""; return; }
            const conv = j2g(p.jy, p.jm, p.jd);
            g.value = `${conv[0]}-${pad2(conv[1])}-${pad2(conv[2])}`;
            if (i === 1) g.dispatchEvent(new Event("change"));
          });
        }
      }
      makeupList.forEach(idx => {
        const j = document.querySelector(`[name="makeup_date_${idx}"]`);
        const g = document.querySelector(`[name="makeup_date_g_${idx}"]`);
        if (j && g){
          j.addEventListener("input", () => {
            const p = parseJ(j.value);
            if (!p) { g.value = ""; return; }
            const conv = j2g(p.jy, p.jm, p.jd);
            g.value = `${conv[0]}-${pad2(conv[1])}-${pad2(conv[2])}`;
          });
        }
      });
      const firstG = document.querySelector('[name="session_date_g_1"]');
      const firstJ = document.querySelector('[name="session_date_1"]');
      if (firstG && firstJ && !firstG.value && firstJ.value){
        const p = parseJ(firstJ.value);
        if (p){
          const conv = j2g(p.jy, p.jm, p.jd);
          firstG.value = `${conv[0]}-${pad2(conv[1])}-${pad2(conv[2])}`;
          firstG.dispatchEvent(new Event("change"));
        }
      }
      const first = document.querySelector('[name="session_date_g_1"]');
      if (first) first.addEventListener('change', propagateSessionDates);
    }

    function renderPicker(container, jInput, gInput){
      container.innerHTML = "";
      const state = { jy: curJ.jy, jm: curJ.jm };
      const header = document.createElement("div"); header.style.display="flex"; header.style.justifyContent="space-between"; header.style.alignItems="center"; header.style.padding="8px";
      const prev = document.createElement("button"); prev.className="btn btn-secondary"; prev.textContent="<"; prev.onclick = () => { state.jm--; if (state.jm<1){ state.jm=12; state.jy--; } renderBody(); };
      const next = document.createElement("button"); next.className="btn btn-secondary"; next.textContent=">"; next.onclick = () => { state.jm++; if (state.jm>12){ state.jm=1; state.jy++; } renderBody(); };
      const title = document.createElement("div"); const mi = Math.max(1, Math.min(12, Number(state.jm||1))) - 1; title.textContent = `${monthsFa[mi]} ${state.jy}`;
      header.appendChild(prev); header.appendChild(title); header.appendChild(next);
      container.appendChild(header);
      const grid = document.createElement("div"); grid.style.display="grid"; grid.style.gridTemplateColumns="repeat(7, 1fr)"; grid.style.gap="6px"; grid.style.padding="8px";
      weekDays.forEach(w => { const c=document.createElement("div"); c.textContent=w; c.style.fontWeight="600"; c.style.textAlign="center"; grid.appendChild(c); });
      container.appendChild(grid);
      function renderBody(){
        grid.innerHTML = "";
        const firstG = j2g(state.jy, state.jm, 1); const firstDay = new Date(firstG[0], firstG[1]-1, firstG[2]).getDay(); const offset = (firstDay + 1) % 7;
        for(let i=0;i<offset;i++){ const e=document.createElement("div"); grid.appendChild(e); }
        const ml = jMonthLen(state.jy, state.jm);
        for(let d=1; d<=ml; d++){
          const cell = document.createElement("button"); cell.className="btn btn-secondary"; cell.style.padding="6px"; cell.textContent = pad2(d);
          cell.onclick = () => { jInput.value = `${pad2(d)}/${pad2(state.jm)}/${state.jy}`; const gParts = j2g(state.jy, state.jm, d); gInput.value = `${gParts[0]}-${pad2(gParts[1])}-${pad2(gParts[2])}`; gInput.dispatchEvent(new Event("change")); container.style.display="none"; };
          grid.appendChild(cell);
        }
      }
      renderBody();
    }
    const clsStudentsPicker = document.getElementById("clsStudentsPicker");
    const clsStudentsDropdown = document.getElementById("clsStudentsDropdown");
    const clsStudentsList = document.getElementById("clsStudentsList");
    const clsStudentsDisplay = document.getElementById("clsStudentsDisplay");
    const clsStudentsSearch = document.getElementById("clsStudentsSearch");
    window.selectedClassStudents = [];
    function clearSelectedClassStudents(){ window.selectedClassStudents = []; renderSelectedClassStudents(); renderStudentsDropdown(window.studentsDataForClass||[]); }
    function renderSelectedClassStudents(){
      clsStudentsDisplay.innerHTML = "";
      if (!window.selectedClassStudents.length) { clsStudentsDisplay.textContent = "انتخاب شاگردان..."; return; }
      window.selectedClassStudents.forEach(s => { const tag = document.createElement("span"); tag.className = "rf-tag"; const full = s.full; tag.textContent = full; clsStudentsDisplay.appendChild(tag); });
      const count = document.createElement("span"); count.className = "rf-tag"; count.textContent = String(window.selectedClassStudents.length);
      clsStudentsDisplay.appendChild(count);
    }
    function toggleClassStudent(s){
      const arr = window.selectedClassStudents;
      const idx = arr.findIndex(x => x.id === s.id);
      if (idx >= 0) arr.splice(idx,1); else arr.push(s);
      renderSelectedClassStudents();
    }
    function renderStudentsDropdown(items){
      clsStudentsList.innerHTML = "";
      items.forEach(st => {
        const row = document.createElement("div"); row.className = "rf-item";
        const cb = document.createElement("input"); cb.type = "checkbox";
        const full = (st.full_name && String(st.full_name).trim()) || [st.name, st.last_name].filter(Boolean).join(" ") || (st.english_name||"بدون نام");
        cb.checked = window.selectedClassStudents.some(x => x.id === (st.id||""));
        cb.onchange = () => toggleClassStudent({ id: st.id || `${st.name}`, full });
        const label = document.createElement("span"); label.textContent = full + (st.phone?` | ${st.phone}`:"") + (st.student_id?` | ${st.student_id}`:"");
        row.appendChild(cb); row.appendChild(label);
        row.onclick = () => { cb.checked = !cb.checked; cb.onchange(); };
        clsStudentsList.appendChild(row);
      });
    }
    async function loadStudentsForClass(){
      const res = await fetch("/api/students"); const students = await res.json();
      window.studentsDataForClass = students;
      renderStudentsDropdown(students);
      renderSelectedClassStudents();
      addClearButton(clsStudentsPicker, clearSelectedClassStudents);
    }
    loadStudentsForClass();
    clsStudentsPicker?.addEventListener("click", () => { const vis = clsStudentsDropdown.style.display === "block"; clsStudentsDropdown.style.display = vis ? "none" : "block"; });
    clsStudentsSearch?.addEventListener("input", () => {
      const q = (clsStudentsSearch.value||"").trim();
      const filtered = q ? (window.studentsDataForClass||[]).filter(st => `${st.full_name||""} ${st.name||""} ${st.last_name||""} ${st.phone||""}`.includes(q)) : (window.studentsDataForClass||[]);
      renderStudentsDropdown(filtered);
    });
    classForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(classForm);
      const payload = Object.fromEntries(fd.entries());
      const days = Array.from(document.querySelectorAll('#clsDays input[type="checkbox"]:checked')).map(i => i.value);
      const studentsSel = (window.selectedClassStudents||[]).map(s => s.id);
      const sessions = [];
      const n = Math.max(1, Number(payload.sessions_count || 1));
      for(let i=1;i<=n;i++){
        sessions.push({ index: i, date: payload[`session_date_${i}`] || null, cancelled: !!payload[`session_cancel_${i}`] });
        delete payload[`session_date_${i}`]; delete payload[`session_cancel_${i}`];
      }
      makeupList.forEach((m, iIdx) => {
        sessions.push({ index: n + iIdx + 1, date: payload[`makeup_date_${m}`] || null, cancelled: !!payload[`makeup_cancel_${m}`], makeup: true });
        delete payload[`makeup_date_${m}`]; delete payload[`makeup_cancel_${m}`];
      });
      payload.days = days;
      payload.students = studentsSel;
      payload.sessions = sessions;
      payload.title = clsCourse.selectedOptions[0]?.textContent || "";
      const tf = document.getElementById("clsTimeFrom")?.value || "";
      const tt = document.getElementById("clsTimeTo")?.value || "";
      payload.time = (tf||tt) ? `${tf} - ${tt}` : (payload.time||"");
      const res = await fetch("/api/classes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json?.ok) { await postWebhook("class_submit", json.cls || payload); }
      showToast(json.ok ? "کلاس ثبت شد" : (`خطا در ثبت کلاس${json?.error?`: ${json.error}`:""}`), json.ok ? "success" : "error");
      closeClassForm();
      loadClasses();
    });
    function renderClasses(items){
      const q = (document.getElementById("classesSearch")?.value||"").trim();
      const filtered = q ? items.filter(x => `${x.title||""} ${x.teacher||""} ${x.code||""}`.includes(q)) : items;
      const list = document.getElementById("classesList");
      list.innerHTML = "";
      filtered.forEach(x => {
        const c = document.createElement("div");
        c.className = "rf-plain-item";
        const info = document.createElement("div");
        info.textContent = `${x.title || ""} | ${x.teacher || ""} | ${x.code || ""}`;
        const actions = document.createElement("div"); actions.className = "actions";
        const edit = document.createElement("button"); edit.className = "btn"; edit.textContent = "ویرایش"; edit.onclick = () => {
          openClassForm();
          Object.entries({ code: x.code, end_date: x.end_date, certificate_issue_date: x.certificate_issue_date }).forEach(([k,v])=>{ const el = classForm.querySelector(`[name="${k}"]`); if (el) el.value = v || ""; });
          clsSessionsCount.value = Number(x.sessions_count||1);
          renderSessionBoxes();
          if (Array.isArray(x.sessions)) {
            x.sessions.forEach(s => {
              const di = classForm.querySelector(`[name="session_date_${s.index}"]`); if (di) di.value = s.date || "";
              const ci = classForm.querySelector(`[name="session_cancel_${s.index}"]`); if (ci) ci.checked = !!s.cancelled;
            });
          }
        };
        const del = document.createElement("button"); del.className = "btn btn-secondary"; del.textContent = "حذف"; del.onclick = async () => {
          if (!x.id) { showToast("شناسه نامعتبر", "error"); return; }
          const res = await fetch(`/api/classes/${x.id}`, { method: "DELETE" }); const json = await res.json().catch(()=>({ ok:false }));
          showToast(json.ok?"کلاس حذف شد":"خطا در حذف", json.ok?"success":"error");
          loadClasses();
        };
        const viewStudents = document.createElement("button"); viewStudents.className = "btn btn-secondary"; viewStudents.textContent = "مشاهده لیست شاگردان"; viewStudents.onclick = async () => {
          const modal = document.getElementById("studentsModal");
          const titleEl = document.getElementById("studentsModalTitle");
          const bodyEl = document.getElementById("studentsModalBody");
          document.getElementById("studentsModalClose")?.addEventListener("click", () => { modal.style.display = "none"; bodyEl.innerHTML = ""; }, { once: true });
          const ids = Array.isArray(x.students) ? x.students : (typeof x.students === "string" ? (x.students ? JSON.parse(x.students) : []) : []);
          titleEl.textContent = `شاگردان کلاس: ${x.title||x.code||""}`;
          bodyEl.innerHTML = "";
          const res = await fetch("/api/students"); const all = await res.json();
          const map = new Map(all.map(s => [s.id, s]));
          if (!ids.length) { bodyEl.textContent = "شاگردی برای این کلاس ثبت نشده است"; modal.style.display = "flex"; return; }
          ids.forEach(sid => {
            const st = map.get(sid) || { id:sid, name:sid };
            const row = document.createElement("div"); row.className = "rf-plain-item";
            const n = (st.name && String(st.name).trim()) || (st.full_name && String(st.full_name).trim()) || (st.english_name||"بدون نام");
            const info = document.createElement("div"); info.textContent = `${n} | ${st.phone||""} ${st.student_id?`| ${st.student_id}`:""}`;
            row.appendChild(info);
            bodyEl.appendChild(row);
          });
          modal.style.display = "flex";
        };
        actions.appendChild(edit); actions.appendChild(del); actions.appendChild(viewStudents);
        c.appendChild(info); c.appendChild(actions);
        list.appendChild(c);
      });
    }
    document.getElementById("classesSearch")?.addEventListener("input", () => renderClasses(window.classesData||[]));
    async function loadClasses() {
      const res = await fetch("/api/classes");
      const items = await res.json();
      window.classesData = items;
      renderClasses(items);
      showToast("کلاس‌ها بارگذاری شد", "success");
    }
    const openAttendanceForm = document.getElementById("openAttendanceForm");
    openAttendanceForm?.addEventListener("click", () => { activate("AttendanceForm"); renderAttendanceClasses(); });
    const attClass = document.getElementById("attClass");
    const attGrid = document.getElementById("attGrid");
    const attSubmit = document.getElementById("attSubmit");
    const attCancel = document.getElementById("attCancel");
    async function renderAttendanceClasses(){
      const res = await fetch("/api/classes"); const classes = await res.json();
      attClass.innerHTML = "";
      classes.forEach(c => { const opt = document.createElement("option"); opt.value = c.id || c.code || ""; opt.textContent = `${c.title||""} | ${c.code||""}`; opt.dataset.sessions = JSON.stringify(c.sessions||[]); opt.dataset.students = (typeof c.students === "string" ? c.students : JSON.stringify(c.students||[])); attClass.appendChild(opt); });
      renderAttendanceGrid();
    }
    function renderAttendanceGrid(){
      attGrid.innerHTML = "";
      const sel = attClass.selectedOptions[0]; if (!sel) return;
      const sessions = JSON.parse(sel.dataset.sessions||"[]");
      const studentsIdsRaw = sel.dataset.students||"[]";
      const studentsIds = (() => { try { const parsed = JSON.parse(studentsIdsRaw); return Array.isArray(parsed) ? parsed : []; } catch { return []; } })();
      const header = document.createElement("div"); header.className = "rf-row"; header.textContent = `جلسات: ${sessions.map(s=>s.index).join(", ")}`; attGrid.appendChild(header);
      Promise.resolve(fetch("/api/students").then(r=>r.json())).then(students => {
        const map = new Map(students.map(s => [s.id, s]));
        studentsIds.forEach(sid => {
          const st = map.get(sid) || { id: sid, name: sid };
          const row = document.createElement("div"); row.className = "rf-row";
          const label = document.createElement("div"); const full = (st.full_name && String(st.full_name).trim()) || [st.name, st.last_name].filter(Boolean).join(" ") || (st.english_name||"بدون نام"); label.textContent = full; row.appendChild(label);
          const boxes = document.createElement("div"); boxes.style.display = "flex"; boxes.style.gap = "8px";
          sessions.forEach(s => { const cb = document.createElement("input"); cb.type="checkbox"; cb.name = `att_${st.id}_${s.index}`; boxes.appendChild(cb); });
          row.appendChild(boxes);
          attGrid.appendChild(row);
        });
      });
    }
    attClass?.addEventListener("change", renderAttendanceGrid);
    attSubmit?.addEventListener("click", async () => {
      const sel = attClass.selectedOptions[0]; if (!sel) return;
      const classId = sel.value;
      const sessions = JSON.parse(sel.dataset.sessions||"[]");
      const inputs = attGrid.querySelectorAll('input[type="checkbox"]');
      const calls = [];
      inputs.forEach(inp => {
        const m = inp.name.match(/^att_(.+)_(\d+)$/); if (!m) return;
        const studentId = m[1]; const session_index = Number(m[2]);
        const present = !!inp.checked;
        calls.push(fetch("/api/classes/attendance", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ classId, studentId, present, session_index }) }));
      });
      await Promise.all(calls);
      showToast("حضور ثبت شد", "success");
    });
    attCancel?.addEventListener("click", () => { activate("ClassesDashboard"); });
    const addStudentFinanceBtn = document.getElementById("addStudentFinanceBtn");
    const studentFinanceFormPanel = document.getElementById("studentFinanceFormPanel");
    const studentFinanceForm = document.getElementById("studentFinanceForm");
    const cancelStudentFinanceForm = document.getElementById("cancelStudentFinanceForm");
    const sfStudent = document.getElementById("sfStudent");
    const sfClass = document.getElementById("sfClass");
    const sfInstallments = document.getElementById("sfInstallments");
    const addInstallmentBtn = document.getElementById("addInstallmentBtn");
    function openStudentFinanceForm(){ studentFinanceForm.reset(); studentFinanceFormPanel.style.display = "block"; sfInstallments.innerHTML = ""; }
    function closeStudentFinanceForm(){ studentFinanceFormPanel.style.display = "none"; }
    addStudentFinanceBtn.addEventListener("click", openStudentFinanceForm);
    cancelStudentFinanceForm.addEventListener("click", closeStudentFinanceForm);
    async function loadSfOptions(){
      const [stRes, clsRes] = await Promise.all([fetch("/api/students"), fetch("/api/classes")]);
      const students = await stRes.json();
      const classes = await clsRes.json();
      sfStudent.innerHTML = "";
      students.forEach(s => { const opt = document.createElement("option"); opt.value = s.id || `${s.name}`; const full = (s.full_name && String(s.full_name).trim()) || [s.name, s.last_name].filter(Boolean).join(" ") || (s.english_name||"بدون نام"); opt.textContent = full; sfStudent.appendChild(opt); });
      sfClass.innerHTML = "";
      classes.forEach(c => { const opt = document.createElement("option"); opt.value = c.code || c.id || ""; opt.textContent = `${c.code||""} - ${c.title||c.name||""}`; sfClass.appendChild(opt); });
    }
    loadSfOptions();
    function addInstallmentRow(){
      const wrap = document.createElement("div"); wrap.className = "card";
      const amt = document.createElement("input"); amt.placeholder = "مبلغ قسط"; amt.name = `installment_amount_${Date.now()}`;
      const dt = document.createElement("input"); dt.type = "date"; dt.name = `installment_date_${Date.now()}`;
      wrap.appendChild(amt); wrap.appendChild(dt);
      sfInstallments.appendChild(wrap);
    }
    addInstallmentBtn.addEventListener("click", addInstallmentRow);
    function attachFinanceJalaliPickers(){
      const uj = document.getElementById("sfUpfrontDateJ");
      const ug = document.getElementById("sfUpfrontDate");
      const ud = document.getElementById("sfUpfrontDrop");
      if (uj && ug && ud){ uj.addEventListener("click", () => { const vis = ud.style.display === "block"; ud.style.display = vis ? "none" : "block"; renderPicker(ud, uj, ug); }); }
      Array.from(sfInstallments.querySelectorAll(".card")).forEach(card => {
        const j = card.querySelector('[name^="installment_date_j_"]');
        const g = card.querySelector('[name^="installment_date_g_"]');
        const dId = (j?.name||"").replace(/^installment_date_j_/, "instDrop_");
        const d = document.getElementById(dId);
        if (j && g && d){ j.addEventListener("click", () => { const vis = d.style.display === "block"; d.style.display = vis ? "none" : "block"; renderPicker(d, j, g); }); }
      });
    }
    const studentFinanceList = document.getElementById("studentFinanceList");
    const studentFinanceSearch = document.getElementById("studentFinanceSearch");
    function renderStudentFinance(items){
      const q = (studentFinanceSearch?.value||"").trim();
      const filtered = q ? items.filter(x => `${x.class_code||""} ${x.status||""} ${x.student_id||""}`.includes(q)) : items;
      studentFinanceList.innerHTML = "";
      filtered.forEach(x => { const c = document.createElement("div"); c.className = "card"; c.textContent = `${x.student_id} | ${x.class_code} | ${x.status}`; studentFinanceList.appendChild(c); });
    }
    studentFinanceSearch?.addEventListener("input", () => renderStudentFinance(window.studentFinanceData||[]));
    async function loadStudentFinance(){
      const res = await fetch("/api/finance/student-profiles");
      const items = await res.json();
      window.studentFinanceData = items;
      renderStudentFinance(items);
    }
    loadStudentFinance();
    studentFinanceForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(studentFinanceForm);
      const obj = Object.fromEntries(fd.entries());
      const installments = [];
      Array.from(sfInstallments.querySelectorAll(".card")).forEach(card => {
        const ia = card.querySelector('[name^="installment_amount_"]');
        const idt = card.querySelector('[name^="installment_date_"]');
        if (ia && idt && idt.value) installments.push({ amount: Number(String(ia.value||"").replace(/[^0-9]/g, "")) || 0, date: idt.value });
      });
      const payload = {
        student_id: obj.student_id,
        class_code: obj.class_code,
        upfront_amount: Number(String(obj.upfront_amount||"").replace(/[^0-9]/g, "")) || 0,
        upfront_date: obj.upfront_date || null,
        installments,
        status: obj.status
      };
      const res = await fetch("/api/finance/student-profiles", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json?.ok) { await postWebhook("student_finance_submit", json.profile || payload); }
      showToast(json.ok ? "پروفایل مالی ثبت شد" : "خطا در ثبت پروفایل", json.ok ? "success" : "error");
      closeStudentFinanceForm();
      loadStudentFinance();
    });
    
    const linksForm = document.getElementById("linksForm");
    const linksView = document.getElementById("linksView");
    async function loadLinks() {
      const res = await fetch("/api/data-links");
      const links = await res.json();
      linksForm.innerHTML = "";
      Object.entries(links).forEach(([k, v]) => {
        const i = document.createElement("input");
        i.name = k;
        i.placeholder = k;
        i.value = v || "";
        linksForm.appendChild(i);
      });
      const btn = document.createElement("button");
      btn.type = "submit";
      btn.textContent = "ذخیره";
      btn.className = "btn";
      linksForm.appendChild(btn);
      linksView.textContent = JSON.stringify(links);
    }
    linksForm.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(linksForm);
      const payload = Object.fromEntries(fd.entries());
      const res = await fetch("/api/data-links", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const json = await res.json();
      linksView.textContent = JSON.stringify(json);
      showToast("لینک‌ها ذخیره شد", "success");
    });
    loadLinks();
    const addTechCourseBtn = document.getElementById("addTechCourseBtn");
    const techCourseFormPanel = document.getElementById("techCourseFormPanel");
    const techCourseForm = document.getElementById("techCourseForm");
    const cancelTechCourseForm = document.getElementById("cancelTechCourseForm");
    const techCoursesList = document.getElementById("techCoursesList");
    const techCoursesSearch = document.getElementById("techCoursesSearch");
    function openTechCourseForm(data=null){
      techCourseForm.reset();
      if (data) Object.entries(data).forEach(([k,v])=>{ const el = techCourseForm.querySelector(`[name="${k}"]`); if(el) el.value = v||""; });
      techCourseFormPanel.style.display = "block";
    }
    function closeTechCourseForm(){ techCourseFormPanel.style.display = "none"; }
    addTechCourseBtn?.addEventListener("click", ()=>openTechCourseForm());
    cancelTechCourseForm?.addEventListener("click", closeTechCourseForm);
    function toFaDigits(str){
      return String(str).replace(/[0-9]/g, d => "۰۱۲۳۴۵۶۷۸۹"[Number(d)]);
    }
    function formatFaNumber(n){
      const s = String(n);
      const parts = s.split(".");
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return toFaDigits(parts.join("."));
    }
    async function uploadBannerFile(file, courseId, name){
      if(!file) return "";
      const fd = new FormData();
      fd.append("file", file);
      if(courseId) fd.append("course_id", courseId);
      if(name) fd.append("name", name);
      const res = await fetch("/api/courses/upload-banner", { method:"POST", body: fd });
      const json = await res.json();
      return json.ok ? (json.url || "") : "";
    }
    function renderTechCourses(items){
      const q = (techCoursesSearch?.value||"").trim();
      const filtered = q ? items.filter(x => `${x.name_fa||""} ${x.name_en||""} ${x.code||""}`.includes(q)) : items;
      techCoursesList.innerHTML = "";
      filtered.forEach(x=>{
        const c = document.createElement("div");
        c.className = "rf-plain-item";
        const tuition = typeof x.tuition !== 'undefined' ? ` | شهریه: ${formatFaNumber(x.tuition)}` : "";
        const hours = typeof x.hours !== 'undefined' ? ` | ساعت: ${formatFaNumber(x.hours)}` : "";
        const title = document.createElement("div");
        title.textContent = `${x.name_fa||""} | ${x.name_en||""} ${x.code?`| ${x.code}`:""}${hours}${tuition}`;
        const actions = document.createElement("div");
        actions.className = "actions";
        const edit = document.createElement("button");
        edit.className = "btn btn-secondary";
        edit.textContent = "ویرایش";
        edit.onclick = ()=>openTechCourseForm(x);
        const del = document.createElement("button");
        del.className = "btn btn-secondary";
        del.textContent = "حذف";
        del.onclick = async ()=>{
          const id = x.id || x.code;
          const res = await fetch(`/api/tech-courses/${id}`, { method: "DELETE" });
          const json = await res.json().catch(()=>({ ok:false }));
          showToast(json.ok?"دوره حذف شد":"خطا در حذف", json.ok?"success":"error");
          loadTechCourses();
          loadCourseOptions();
        };
        actions.appendChild(edit);
        actions.appendChild(del);
        c.appendChild(title);
        c.appendChild(actions);
        techCoursesList.appendChild(c);
      });
    }
    techCoursesSearch?.addEventListener("input", ()=>renderTechCourses(window.techCoursesData||[]));
    async function loadTechCourses(){
      const res = await fetch("/api/tech-courses");
      const items = await res.json();
      window.techCoursesData = items;
      renderTechCourses(items);
    }
    loadTechCourses();
    techCourseForm?.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd = new FormData(techCourseForm);
      const payload = Object.fromEntries(fd.entries());
      const id = payload.id;
      let res;
      if(id) res = await fetch(`/api/tech-courses/${id}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      else res = await fetch("/api/tech-courses", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      const json = await res.json();
      if (json?.ok) { await postWebhook(id?"tech_course_update":"tech_course_submit", json.course || payload); }
      showToast(id?"دوره فنی به‌روزرسانی شد":"دوره فنی اضافه شد", json.ok?"success":"error");
      closeTechCourseForm();
      loadTechCourses();
    });
    

    const addSchoolCourseBtn = document.getElementById("addSchoolCourseBtn");
    const schoolCourseFormPanel = document.getElementById("schoolCourseFormPanel");
    const schoolCourseForm = document.getElementById("schoolCourseForm");
    const cancelSchoolCourseForm = document.getElementById("cancelSchoolCourseForm");
    const schoolCoursesList = document.getElementById("schoolCoursesList");
    const schoolCoursesSearch = document.getElementById("schoolCoursesSearch");
    function openSchoolCourseForm(data=null){
      schoolCourseForm.reset();
      if (data) Object.entries(data).forEach(([k,v])=>{ const el = schoolCourseForm.querySelector(`[name="${k}"]`); if(el) el.value = v||""; });
      schoolCourseFormPanel.style.display = "block";
      const prev = document.getElementById("schoolBannerPreview");
      if (prev) {
        prev.innerHTML = "";
        if (data?.banner) {
          const box = document.createElement("div"); box.className = "thumb-box";
          const img = document.createElement("img"); img.src = data.banner; img.alt = data.name||""; img.className = "course-thumb";
          const url = document.createElement("div"); url.textContent = data.banner;
          box.appendChild(img);
          prev.appendChild(box);
          prev.appendChild(url);
        } else {
          prev.textContent = "بنر: ندارد";
        }
      }
    }
    function closeSchoolCourseForm(){ schoolCourseFormPanel.style.display = "none"; }
    addSchoolCourseBtn?.addEventListener("click", ()=>openSchoolCourseForm());
    cancelSchoolCourseForm?.addEventListener("click", closeSchoolCourseForm);
    function renderSchoolCourses(items){
      const q = (schoolCoursesSearch?.value||"").trim();
      const filtered = q ? items.filter(x => `${x.name||""} ${x.teacher||""}`.includes(q)) : items;
      schoolCoursesList.innerHTML = "";
      filtered.forEach(x=>{
        const c = document.createElement("div");
        c.className = "rf-plain-item";
        const hourText = x.hour ? ` | ساعت: ${formatFaNumber(x.hour)}` : "";
        const sessionsText = (typeof x.sessions_count !== 'undefined') ? ` | جلسات: ${formatFaNumber(x.sessions_count)}` : "";
        const tuitionText = (typeof x.tuition !== 'undefined') ? ` | شهریه: ${formatFaNumber(x.tuition)}` : "";
        const title = document.createElement("div");
        const text = document.createElement("span");
        text.textContent = `${x.name||""} | ${x.teacher||""}${hourText}${sessionsText}${tuitionText}`;
        title.appendChild(text);
        const bannerInfo = document.createElement("div"); bannerInfo.style.marginTop = "4px";
        bannerInfo.textContent = x.banner ? `بنر: ${x.banner}` : "بنر: ندارد";
        title.appendChild(bannerInfo);
        const actions = document.createElement("div");
        actions.className = "actions";
        // نمایش thumbnail بنر کنار دکمه‌ها
        if (x.banner) {
          const box = document.createElement("div"); box.className = "thumb-box";
          const img = document.createElement("img"); img.src = x.banner; img.alt = x.name||""; img.className = "course-thumb";
          box.appendChild(img);
          actions.appendChild(box);
        }
        const edit = document.createElement("button");
        edit.className = "btn btn-secondary";
        edit.textContent = "ویرایش";
        edit.onclick = ()=>{ openSchoolCourseForm(x); c.insertAdjacentElement("afterend", schoolCourseFormPanel); };
        const del = document.createElement("button");
        del.className = "btn btn-secondary";
        del.textContent = "حذف";
        del.onclick = async ()=>{
          const id = x.id || x.name;
          const res = await fetch(`/api/courses/${id}`, { method: "DELETE" });
          const json = await res.json().catch(()=>({ ok:false }));
          showToast(json.ok?"دوره حذف شد":"خطا در حذف", json.ok?"success":"error");
          loadSchoolCourses();
          loadCourseOptions();
        };
        actions.appendChild(edit);
        actions.appendChild(del);
        c.appendChild(title);
        c.appendChild(actions);
        schoolCoursesList.appendChild(c);
      });
    }
    schoolCoursesSearch?.addEventListener("input", ()=>renderSchoolCourses(window.schoolCoursesData||[]));
    async function loadSchoolCourses(){
      const res = await fetch("/api/courses");
      const items = await res.json();
      window.schoolCoursesData = items;
      renderSchoolCourses(items);
    }
    loadSchoolCourses();
    schoolCourseForm?.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd = new FormData(schoolCourseForm);
      const payload = Object.fromEntries(fd.entries());
      payload.tuition = Number(String(payload.tuition||"").replace(/[^0-9]/g, "")) || 0;
      payload.hour = Number(String(payload.hour||"").replace(/[^0-9]/g, "")) || 0;
      payload.sessions_count = Number(String(payload.sessions_count||"").replace(/[^0-9]/g, "")) || 0;
      const bannerInput = document.getElementById("schoolBannerFile");
      const bannerFile = bannerInput?.files?.[0] || null;
      const id = payload.id;
      let saved;
      if(id){
        if(bannerFile){
          const url = await uploadBannerFile(bannerFile, id, payload.name);
          if(url) payload.banner = url; else showToast("خطا در آپلود بنر", "error");
        }
        const res = await fetch(`/api/courses/${id}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
        const json = await res.json();
        saved = json;
      } else {
        const res = await fetch("/api/courses", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
        const created = await res.json();
        saved = created;
        if(created?.ok){
          const courseId = created.course?.id || "";
          if(bannerFile && courseId){
            const url = await uploadBannerFile(bannerFile, courseId, payload.name);
            if(url){
              const res2 = await fetch(`/api/courses/${courseId}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ banner: url })});
              const json2 = await res2.json();
              if (!json2.ok) showToast(`خطا در ذخیره بنر: ${json2.error||""}`, "error");
              saved = json2?.ok ? json2 : saved;
            } else {
              showToast("خطا در آپلود بنر", "error");
            }
          }
        }
      }
      if (saved?.ok) { await postWebhook(id?"school_course_update":"school_course_submit", saved.course || payload); }
      showToast(id?"دوره آموزشگاهی به‌روزرسانی شد":"دوره آموزشگاهی اضافه شد", saved?.ok?"success":"error");
      closeSchoolCourseForm();
      loadSchoolCourses();
    });
    const addTeacherBtn = document.getElementById("addTeacherBtn");
    const teachersList = document.getElementById("teachersList");
    const teachersSearch = document.getElementById("teachersSearch");
    const teacherFormPanel = document.getElementById("teacherFormPanel");
    const teacherForm = document.getElementById("teacherForm");
    const cancelTeacherForm = document.getElementById("cancelTeacherForm");
    function openTeacherForm(data=null){ teacherForm.reset(); if (data){ Object.entries(data).forEach(([k,v])=>{ const el = teacherForm.querySelector(`[name="${k}"]`); if (el) el.value = v || ""; }); } teacherFormPanel.style.display = "block"; }
    function closeTeacherForm(){ teacherFormPanel.style.display = "none"; }
    addTeacherBtn?.addEventListener("click", ()=> openTeacherForm());
    cancelTeacherForm?.addEventListener("click", closeTeacherForm);
    function renderTeachers(items){
      const q = (teachersSearch?.value||"").trim();
      const filtered = q ? items.filter(t => `${t.name||""} ${t.phone||""} ${t.skills||""}`.includes(q)) : items;
      teachersList.innerHTML = "";
      filtered.forEach(t => {
        const c = document.createElement("div"); c.className = "rf-plain-item";
        const info = document.createElement("div"); info.textContent = `${t.name||""} | ${t.phone||""}`;
        const actions = document.createElement("div"); actions.className = "actions";
        const edit = document.createElement("button"); edit.className = "btn"; edit.textContent = "ویرایش"; edit.onclick = () => openTeacherForm(t);
        const del = document.createElement("button"); del.className = "btn btn-secondary"; del.textContent = "حذف"; del.onclick = async () => {
          if (!t.id) { showToast("شناسه نامعتبر", "error"); return; }
          const res = await fetch(`/api/teachers/${t.id}`, { method: "DELETE" }); const json = await res.json().catch(()=>({ ok:false }));
          showToast(json.ok?"مدرس حذف شد":"خطا در حذف", json.ok?"success":"error");
          loadTeachers();
        };
        actions.appendChild(edit); actions.appendChild(del);
        c.appendChild(info); c.appendChild(actions);
        teachersList.appendChild(c);
      });
    }
    teachersSearch?.addEventListener("input", () => renderTeachers(window.teachersData||[]));
    async function loadTeachers(){ const res = await fetch("/api/teachers"); const items = await res.json(); window.teachersData = items; renderTeachers(items); }
    loadTeachers();
    teacherForm?.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(teacherForm);
      const obj = Object.fromEntries(fd.entries());
      const id = obj.id;
      let res;
      if (id) res = await fetch(`/api/teachers/${id}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(obj) });
      else res = await fetch("/api/teachers", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(obj) });
      const json = await res.json().catch(()=>({ ok:false }));
      showToast(json.ok? (id?"مدرس به‌روزرسانی شد":"مدرس اضافه شد") : "خطا در ثبت مدرس", json.ok?"success":"error");
      if (json.ok){ closeTeacherForm(); loadTeachers(); }
    });
    // دکمه افزودن مدرس از فرم کلاس حذف شده است
</script>
  </body>
  </html>
